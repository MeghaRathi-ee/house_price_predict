# Trigger test run - verifying DagsHub token fix
name: CI/CD Pipeline - House Price Predict

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-train-deploy:
    runs-on: ubuntu-latest

    steps:
      # ‚úÖ Checkout the repository
      - name: Checkout Repository
        uses: actions/checkout@v3

      # ‚úÖ Set up Python
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      # ‚úÖ Install dependencies
      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # ‚úÖ Configure DVC Remote (DagsHub)
      - name: Configure DVC Remote
        env:
          DAGSHUB_USER: ${{ secrets.DAGSHUB_USER }}
          DAGSHUB_TOKEN: ${{ secrets.DAGSHUB_TOKEN }}
        run: |
          echo "üîß Setting up DVC remote for DagsHub..."
          dvc remote remove origin || true
          dvc remote add -d origin https://dagshub.com/MeghaRathi-ee/house_price_predict.dvc
          dvc remote modify origin auth basic
          dvc remote modify origin user $DAGSHUB_USER
          dvc remote modify origin password $DAGSHUB_TOKEN
          echo "‚úÖ Remote configured successfully"
          dvc remote list

      # ‚úÖ Pull Dataset from DVC (with fallback and debug)
      - name: Pull Dataset from DVC (Full Auth)
        env:
          DAGSHUB_USER: ${{ secrets.DAGSHUB_USER }}
          DAGSHUB_TOKEN: ${{ secrets.DAGSHUB_TOKEN }}
        run: |
          echo "üîß Setting up DVC remote and pulling data..."
          dvc remote remove origin || true
          dvc remote add -d origin https://dagshub.com/MeghaRathi-ee/house_price_predict.dvc
          dvc remote modify origin auth basic
          dvc remote modify origin user $DAGSHUB_USER
          dvc remote modify origin password $DAGSHUB_TOKEN

          echo "‚¨áÔ∏è Attempting to pull dataset..."
          if ! dvc pull -v; then
            echo "‚ö†Ô∏è DVC pull failed ‚Äî using fallback download instead."
            mkdir -p data
            curl -L -o data/houseprices.csv https://dagshub.com/MeghaRathi-ee/house_price_predict/raw/main/data/houseprices.csv
            echo "‚úÖ Dataset downloaded via fallback URL."
          else
            echo "‚úÖ Dataset pulled successfully using DVC."
          fi

          echo "üìÅ Verifying data directory contents:"
          ls -R data || echo "‚ö†Ô∏è Data folder missing!"

          echo "üìÑ Verifying exact file path:"
          if [ -f "data/houseprices.csv" ]; then
            echo "‚úÖ Found data/houseprices.csv ‚úÖ"
          else
            echo "‚ùå data/houseprices.csv not found, forcing fallback download..."
            mkdir -p data
            curl -L -o data/houseprices.csv https://dagshub.com/MeghaRathi-ee/house_price_predict/raw/main/data/houseprices.csv
            echo "‚úÖ Data fetched manually."
          fi

      - name: Debug - Show Folder Structure
        run: |
          echo "üìÇ Printing project folder structure"
          pwd
          ls -R

      # ‚úÖ Set up DagsHub credentials for MLflow
      - name: Set up DagsHub credentials
        run: echo "üîë Setting up DagsHub credentials..."
        env:
          DAGSHUB_USER: MeghaRathi-ee
          DAGSHUB_TOKEN: ${{ secrets.DAGSHUB_TOKEN }}

      # ‚úÖ Run Training Pipeline with MLflow logging
      - name: Run Training Pipeline
        run: |
          python -m src.train_model
        env:
          DAGSHUB_USER: MeghaRathi-ee
          DAGSHUB_TOKEN: ${{ secrets.DAGSHUB_TOKEN }}

      # ‚úÖ Build Docker Image
      - name: Build Docker Image
        run: |
          docker build -t house_price_app .

      # ‚úÖ Log in to Docker Hub
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # ‚úÖ Push Docker Image to Docker Hub
      - name: Push Docker Image
        run: |
          echo "üê≥ Tagging and pushing Docker image..."
          docker tag library/house_price_app:latest ${{ secrets.DOCKER_USERNAME }}/house_price_app:latest || \
          docker tag house_price_app:latest ${{ secrets.DOCKER_USERNAME }}/house_price_app:latest

          docker push ${{ secrets.DOCKER_USERNAME }}/house_price_app:latest
